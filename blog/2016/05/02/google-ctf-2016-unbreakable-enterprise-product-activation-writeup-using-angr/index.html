
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>google ctf 2016 unbreakable enterprise product activation writeup (using angr) - 99 Cruster</title>
  <meta name="author" content="binerdd">

  
  <meta name="description" content="This was a simple binary that accepts product key as a commandline argument and it prints Thank you - product activated! message if the key is &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.99cruster.com/blog/2016/05/02/google-ctf-2016-unbreakable-enterprise-product-activation-writeup-using-angr/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="99 Cruster" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">99 Cruster</a></h1>
  
    <h2>Blogging about reverse engineering</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.99cruster.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/categories/ctf">CTF</a></li>
  <li><a href="/blog/categories/translation">Docs</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Google Ctf 2016 Unbreakable Enterprise Product Activation Writeup (Using Angr)</h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-05-02T22:51:15+09:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>This was a simple binary that accepts product key as a commandline argument and it prints <code>Thank you - product activated!</code> message if the key is correct.</p>

<p><img class="center" src="/images/googlectf-unbreakable-1.png"></p>

<p>Loading the binary in IDA, you can see a basic check is made whether commandline argument is given and branches to the right basic block if true. The commandline argument, which is the product key given by the user, is copied to a global buffer <code>dest</code> by the size <code>0x43</code> using <code>strncpy</code>. And rest of the code calls all these functions that do byte operations on the product key and terminate if key is invalid. If the given product key passes all the byte operation checks, at last <code>ActivationSuccess</code> function is called.</p>

<p><img class="center" src="/images/googlectf-unbreakable-2.png">
<img class="center" src="/images/googlectf-unbreakable-3.png"></p>

<p>One can reverse engineer all the checks done inside the functions and generate the product key, but there are too much! Therefore instead of going through all the functions, I decided to use <code>angr</code>. Symbolic execution is good at this type of &ldquo;find satisfying key&rdquo; type challenge.</p>

<p>Here is the python script for solving the challenge with <code>angr</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">angr</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">claripy</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">simuvex</span>
</span><span class='line'>
</span><span class='line'><span class="n">angr</span><span class="o">.</span><span class="n">path_group</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span> <span class="s">&quot;DEBUG&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">p</span> <span class="o">=</span> <span class="n">angr</span><span class="o">.</span><span class="n">Project</span><span class="p">(</span> <span class="s">&quot;unbreakable-enterprise-product-activation&quot;</span> <span class="p">,</span> <span class="n">load_options</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;auto_load_libs&#39;</span> <span class="p">:</span> <span class="bp">False</span><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="n">flag</span> <span class="o">=</span> <span class="n">claripy</span><span class="o">.</span><span class="n">BVS</span><span class="p">(</span> <span class="s">&#39;flag&#39;</span><span class="p">,</span><span class="mh">0x43</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
</span><span class='line'><span class="n">initial_state</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">blank_state</span><span class="p">(</span><span class="n">addr</span><span class="o">=</span> <span class="mh">0x4005BD</span><span class="p">)</span>
</span><span class='line'><span class="n">initial_state</span><span class="o">.</span><span class="n">mem</span><span class="p">[</span> <span class="mh">0x6042c0</span><span class="p">]</span> <span class="o">=</span> <span class="n">flag</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">flag</span><span class="o">.</span><span class="n">chop</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
</span><span class='line'>        <span class="n">initial_state</span><span class="o">.</span><span class="n">add_constraints</span><span class="p">(</span><span class="n">b</span><span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">pg</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">initial_state</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">ex</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">surveyors</span><span class="o">.</span><span class="n">Explorer</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">pg</span><span class="p">,</span> <span class="n">find</span><span class="o">=</span> <span class="mh">0x400830</span><span class="p">)</span>
</span><span class='line'><span class="n">ex</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span><span class='line'><span class="n">state</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="n">found</span><span class="p">[</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">state</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">8</span><span class="p">):</span>
</span><span class='line'>        <span class="n">b</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="mh">0x6042C0</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span> <span class="p">)</span>
</span><span class='line'>        <span class="n">state</span><span class="o">.</span><span class="n">add_constraints</span><span class="p">(</span><span class="n">b</span><span class="o">&gt;=</span> <span class="mh">0x21</span><span class="p">,</span> <span class="n">b</span><span class="o">&lt;=</span><span class="mh">0x7E</span> <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="nb">hex</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">se</span><span class="o">.</span><span class="n">any_int</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="mh">0x6042C0</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">)))[</span><span class="mi">2</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span> <span class="s">&#39;hex&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39; </span><span class="se">\0</span><span class="s">&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>I started analysis at the address right after the <code>strncpy</code>, so that I can make the global buffer <code>dest</code> symbolic without worrying about passing symbolic string as commandline argument, etc. <code>0x4005BD</code> is the address right after the <code>strncpy</code> and <code>0x6042C0</code> is the address of the global buffer. From the code, you can see that I made a symbolic string of size <code>0x43</code> and stored it to the global buffer. After that few constraints are added to make sure there are no null bytes and are printable ascii bytes(actually got the contraint code from other angr <a href="https://github.com/angr/angr-doc/blob/master/examples/whitehat_crypto400/solve.py">writeup</a>).</p>

<p>Then all you have to do is find a path to <code>0x400830</code> using <code>Surveyors</code> which is the address of the call instruction to <code>ActivateSuccess</code> function.
Finding the satisfying symbolic string produces the key:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">(</span>angr<span class="o">)</span> vagrant@irene64:/vagrant<span class="nv">$ </span>python unbreakable.py
</span><span class='line'>CTF<span class="o">{</span>0The1Quick2Brown3Fox4Jumped5Over6The7Lazy8Fox9<span class="o">}</span>@@@@@@@@@@@@@@@@
</span></code></pre></td></tr></table></div></figure>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">binerdd</span></span>

      








  


<time datetime="2016-05-02T22:51:15+09:00" pubdate data-updated="true"></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/ctf/'>ctf</a>, <a class='category' href='/blog/categories/googlectf/'>googlectf</a>, <a class='category' href='/blog/categories/reversing/'>reversing</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://www.99cruster.com/blog/2016/05/02/google-ctf-2016-unbreakable-enterprise-product-activation-writeup-using-angr/" data-via="" data-counturl="http://www.99cruster.com/blog/2016/05/02/google-ctf-2016-unbreakable-enterprise-product-activation-writeup-using-angr/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/07/10/analysis-and-exploitation-of-eset-vulnerability-kor/" title="Previous Post: (번역)Analysis and Exploitation of an ESET Vulnerability">&laquo; (번역)Analysis and Exploitation of an ESET Vulnerability</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/05/02/google-ctf-2016-unbreakable-enterprise-product-activation-writeup-using-angr/">google ctf 2016 unbreakable enterprise product activation writeup (using angr)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/07/10/analysis-and-exploitation-of-eset-vulnerability-kor/">(번역)Analysis and Exploitation of an ESET Vulnerability</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/08/howto-install-jekyll-on-windows/">Howto Install Jekyll On Windows</a>
      </li>
    
  </ul>
</section>




<section>
  <h1>Categories</h1>
    <ul id="category-list"><li><a href='/blog/categories/ctf'>ctf (1)</a></li><li><a href='/blog/categories/googlectf'>googlectf (1)</a></li><li><a href='/blog/categories/googleprojectzero'>googleprojectzero (1)</a></li><li><a href='/blog/categories/howto'>howto (1)</a></li><li><a href='/blog/categories/reversing'>reversing (1)</a></li><li><a href='/blog/categories/translation'>translation (1)</a></li></ul>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - binerdd -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a>. Design by <a href="http://octopressthemes.com">Octopress Themes</a>.</span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'binerdd87';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.99cruster.com/blog/2016/05/02/google-ctf-2016-unbreakable-enterprise-product-activation-writeup-using-angr/';
        var disqus_url = 'http://www.99cruster.com/blog/2016/05/02/google-ctf-2016-unbreakable-enterprise-product-activation-writeup-using-angr/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
